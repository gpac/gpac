This is the documentation for creating a new test in GPAC test suite.

# Running the test suite

To run the entire test suite, simply run `make_tests.sh` or use the Makefile task `make test_suite`.
To run a particular script, run `make_tests.sh ascript.sh`.

Running the test suite or a given test generates:
- result/all_logs.txt: logs of all tests that were executed 
- result/all_results.xml: GNU time/gtime statistics and execution status of all tests that were executed

The different options of make_tests.sh can are given by the command:
```
make_tests.sh -h
```
In particular, tests are cached, so that only failed tests are re-launched when running the test suite. 

# Writing a test
GPAC test suite is composed of scripts written in the Bash language. Tests are placed in gpac/tests/scripts/. Each .sh file in that folder will be executed when running the entire test suite or may be run individually. 

Media files used in a test can be anywhere (local file, http URL). The environmnent variable `$MEDIA_DIR` can be used to access to data located in gpac/tests/media. 

Scripts can use the `$TEMP_DIR` environment variable to get a directory where to place temporary files and the `$LOCAL_OUT_DIR` environment variable for final files generated by the tests.

A simple GPAC test can be:
```
#!/bin/sh
MP4Box -add $MEDIA_DIR\foo.bar $LOCAL_OUT_DIR\foo.mp4
```
or 
```
#!/bin/sh
MP4Client $MEDIA_DIR\foo.mp4
```

In order to produce the unified test report for all the tests, with common timing, logging, etc, `make_tests.sh` defines several functions that should be used in a test.

Each test has its own log file $LOGS in which you can write (a lot is already in there, such as test name/data and all stderr).

## Simple Testing
A simple test whose result will be integrated in the test suite report is run using the single_test function.

### single_test 
Takes two arguments: CMD_LINE and TESTNAME
Executes the given CMD_LINE (between quotes). 
Each call generates:
- a log file called `TESTNAME-logs.txt`. You should not use the `-lf` or `-logs` options of GPAC tools.
- a file called `TESTNAME-passed.xml` containg the statistics of the test, as retrieved by GNU time/gtime.
TESTNAME shall be unique in the test suite. In case of doubts, run the test suite script with `-check-name`.

A simple test using `single_test` looks like:
```
#!/bin/sh
single_test 'MP4Box -add $MEDIA_DIR\foo.bar $LOCAL_OUT_DIR\foo.mp4' test01
```
or 
```
#!/bin/sh
single_test 'MP4Client $MEDIA_DIR\foo.mp4' test02
```

## Aggregating tests
When the results of several tests need to be aggregated, instead of using multiple `single_test` calls, sub-tests can be run within a test using the `do_test` function. 

A typical test with two subtests will look like:
```
test_begin TESTNAME
do_test CMD_LINE1 "Name1"
do_test CMD_LINE1 "Name2"
test_end
```

### test_begin 
Argument:
- TESTNAME, as used in `single_test`, is the base identifier of your test, all output files will be called TESTNAME-*

### do_test
Two arguments:
- CMD_LINE: the command line to execute
- SUBTEST_NAME: the subtest name as it appears in the logs and in the stats

If needed, the return value is available in $ret.

### test_end
Triggers the end of the test and writes all logs and statistics
The function evaluates the variable $result. If not empty, the test is considered failed, otherwise (default) the test has passed. 
All results or subtests are automatically appended to the $result variable in the end_test function.
WARNING: this variable can not be set in a subshell (eg through my_function SOME_PARAM &)

## Test failure/success
A test is considered successful if the execution returned 0.
Some tests may return a non-zero value and still be considered successful (e.g. negative tests). In that case, errors to be ignored are placed in a file in the gpac/rules directory. If any of the line in this file is found, the test is considered successful. 
Each file is named:
- single-TESTNAME-stderr.txt for tests run with the function single_test
- $TESTNAME-$SUBTEST-stderr.txt for subtests run with do_test

## Customized test 
To customize a test, a file named $TESTNAME.sh can be placed in the gpac/rules directory. It is called before the actual test is run and allows custom variables to be set or overriding a given variable in a batch of tests.

## Testing interactivity
This test looks for the files:
- $RULES_DIR/${basename $FILE.*}-$SUBTEST-ui.xml : specifies the recorded trace of UI interactions

## Testing and caching results
In order to avoid running all tests all the times, the GPAC testing environment caches previous test results. If an XML file corresponding to the test or subtest exists in the results folder, the test or subtest is not run. If you want to ignore previous results, use `make_tests.sh -force` or use `make_tests.sh -clean` before running the test.

## Parallel tests with subscripts

Subtests may be run in subscripts, for example:
```
test_begin TESTNAME
 do_test CMD_LINE1 "Name1" &
 do_test CMD_LINE1 "Name2" &
test_end
```

Tests may also be run in subscript, for example:
```
function my_test {
  test_begin $2
  do_test $1 $2
  test_end
}

my_test CMD_LINE1 "Name1" &
my_test CMD_LINE2 "Name2" &
```

## Testing regressions

TODO: The text below needs further checking and editing

To compare the output of a test with a previously generated output and detect regressions, the GPAC testing environment can cache these outputs. Because the output can be huge, only a SHA-1 hash of the output is kept as a reference for each test or subtest. Some specific functions can be used to test hashes when running a test.

### do_hash_test 
Takes two arguments: FILE and PARX
Creates a SHA-1 of FILE and compares it with the reference $TESTNAME-$PARX.hash. 

### do_playback_test 
Arguments: FILE SUBTEST
Called after `test_begin`, `do_playback_test` tests the playback of FILE by extracting it to a raw AVI and hashing both audio and video tracks. The subtest name for logs is SUBTEST.
The generated hashes are:
-  $TESTNAME-$SUBTEST-avirawvideo.hash
-  $TESTNAME-$SUBTEST-avirawaudio.hash

The generated videos are
-  external_videos_refs/$TESTNAME-$SUBTEST-ref.mp4 reference video file (not used by test suite, only used for visual checking of the generation)
-  results/videos/$TESTNAME-$SUBTEST-test.mp4  video file after test (not used by test suite, only used for debugging a test)

Note: you only need to specify SUBTEST as a hash name in `test_begin`, -avirawaudio and -avirawvideo are checked automatically

This function uses overridable variables:
- $dump_size: by default "200x200" but can be overriden by your test
- $dump_dur: by default "10" seconds but can be overriden by your test

### single_playback_test 
Takes two arguments: MP4CLIENT_ARGS TESTNAME
Performs a single playback test using MP4Client with the arguments given in $MP4CLIENT_ARGS. $TESTNAME is used a test name
The result of the playback is captured as a raw audio/video AVI and a SHA-1 hash of this AVI is generated.

### do_compare_file_hashes FILE1 FILE2
Compares hashes of FILE1 and FILE2. returns 0 if OK or error code otherwise.

### Generating References Hashes

### test_begin and test_end with hash
`test_begin` can be called with a list of names as arguments. Each name is used to compute a file name containing a hash to generate. After calling `test_begin`, the `$test_skip` variable is set to 0 or 1. When set to 1, it indicates that all subtests are OK in the cache and all subtests can be skipped and `test_end` not called. The `test_end` function shall be called at the end of the test started with `test_begin` only when `$test_skip` is 0.

A typical test with several subtests and hash testing looks like:
```
test_begin TESTNAME PAR1 ... PARN
if [ $test_skip = 1 ] ; then
 return
fi
 
#create some file or costly operation
do_test CMD_LINE1 "Name1"
#create some other file or costly operation
do_test CMD_LINE1 "Name2"
test_end
```








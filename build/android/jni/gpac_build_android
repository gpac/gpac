#!/bin/bash

echo -e "\033[32m Note: You have to install Android NDK and setup the environment first!\033[0m"
echo -e "\033[32m Note: You have to compile extra_libs first!\033[0m"

if [ -z "$1" ]
then
  echo "$1 : You must give as first argument the directory path of the NDK"
  exit 1
fi

export PATH="$1:$PATH"

# Be sure to resolve if script not called from its directory
SCRIPT_PATH=$(dirname $"0")
cd "$SCRIPT_PATH"
BUILDPATH=$(pwd)

cd "$BUILDPATH" || exit 1
echo "*** Build path is $BUILDPATH, setting revision number"

echo "#define GPAC_SVN_REVISION \"$(svnversion)\"" > ../../../include/gpac/version.h || exit 1
echo "Building lib gpac ..."
mkdir ../../../bin/android 2>/dev/null
cd ../../../ || exit 1
BASEPATH=$(pwd)
cd bin/android || exit 1
BINPATH=$(pwd)

cd $BUILDPATH || exit 1
echo -n "Buiding all libs from $BUILDPATH..."
ndk-build && echo "OK build successful" || (echo "Build FAILED" ; exit 1)

echo "Copying libs to $BINPATH..."
cp  ../libs/armeabi/libgpac.so ../libs/armeabi/libjavaenv.so  $BINPATH || exit 1

echo "Renaming modules and copying modules to $BINPATH..."
cd ../libs/armeabi || exit 1
for fn in libgm*.so
do
	mv "$fn" "$BINPATH/${fn##lib}" || exit 1
done

echo "Building gpac wrapper..."

cd $BASEPATH/applications/osmo4_android || exit 1
ndk-build -B

echo "Copying libs from $BASEPATH/extra_lib/lib/android to $BASEPATH/applications/osmo4_android/libs/armeabi ..."

cd $BASEPATH/extra_lib/lib/android || exit 1
for fn in *.so; do
	cp $fn $BASEPATH/applications/osmo4_android/libs/armeabi
done

echo "Copying all libs to $BASEPATH/applications/osmo4_android/libs/armeabi..."
cp $BINPATH/lib*.so $BASEPATH/applications/osmo4_android/libs/armeabi || exit 1
cp $BINPATH/gm*.so $BASEPATH/applications/osmo4_android/res/raw/ || exit 1

#cp $BASEPATH/applications/osmo4_android/bin/*.apk $BINPATH || exit 1

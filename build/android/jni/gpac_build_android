#!/bin/bash

echo -e "\033[32m Note: You have to install Android NDK and setup the environment first!\033[0m"
echo -e "\033[32m Note: You have to compile extra_libs first!\033[0m"

if [ -z "$1" ]
then
  echo "Usage: $0 PATH_TO_ANDROID_NDK [ADDITIONAL_NDK-BUILD arguments] : You must give as first argument the directory path of the NDK"
  exit 1
fi

export PATH="$1:$PATH"
shift

# Be sure to resolve if script not called from its directory
SCRIPT_PATH=$(dirname $"0")
cd "$SCRIPT_PATH"
BUILDPATH=$(pwd)

cd "$BUILDPATH" || exit 1
version=$(svnversion)
echo "*** Build path is $BUILDPATH, setting revision number $version"
grep "$version" ../../../include/gpac/version.h 1>/dev/null && echo "Version $version already set" || echo "#define GPAC_SVN_REVISION \"$version\"" > ../../../include/gpac/version.h || exit 1
echo "Building lib gpac ..."
mkdir ../../../bin/android 2>/dev/null
cd ../../../ || exit 1
BASEPATH=$(pwd)

cd $BUILDPATH || exit 1
echo -n "Buiding all libs from $BUILDPATH..."
ndk-build $* && echo "[OK] build successful." || echo "Build FAILED" || exit 1

echo "Copying modules to modules dir..."
cd ../libs/ || exit 1
for i in $(find . -name 'gm*.so')
do
	echo -n "$i..."
	cp "$i" "$BASEPATH/applications/osmo4_android/res/raw/" || exit 1
done
echo
echo "[OK] success." 

LIBS_DIR="$BASEPATH/applications/osmo4_android/libs/"
echo "Copying libs to libs dir $LIBS_DIR ..."
for i in $(find . -name 'lib*.so')
do
	echo -n "$i..."
	cp "$i" "$LIBS_DIR/$i" ||Â exit 1
done
echo
echo "[OK] success."
echo "Copying all extra libs..."
cp $BASEPATH/extra_lib/lib/android/lib*.so "$LIBS_DIR/armeabi/" || echo "FAILED"
echo "[OK] success."

#!/bin/bash

echo -e "\033[32m Note: You have to install Android NDK and setup the environment first!\033[0m"
echo -e "\033[32m Note: You have to compile extra_libs first!\033[0m"

if [ -z "$1" ]
then
  echo "Usage: $0 PATH_TO_ANDROID_NDK [ADDITIONAL_NDK-BUILD arguments] : You must give as first argument the directory path of the NDK"
  exit 1
fi

if [ -z "$2" ]
then
  echo "Usage: $0 PATH_TO_ANDROID_SDK : You must give as second argument the directory path of the SDK"
  exit 1
fi

if [ -z "$3" ]
then
  echo "Usage: $0 PATH_TO_ANT : You must give as first third the directory path of ANT"
  exit 1
fi

export PATH="$1:$PATH"
export PATH="$2/tools:$PATH"
export PATH="$3/bin:$PATH"
shift

# Be sure to resolve if script not called from its directory
export BUILDPATH=$(dirname "$0")
cd $BUILDPATH || exit 1
export BUILDPATH=$(pwd)
echo "Current Dir = $BUILDPATH"
version=$(svnversion)
echo "*** Build path is $BUILDPATH, setting revision number $version"
grep "$version" ../../../include/gpac/version.h 1>/dev/null && echo "Version $version already set" || echo "#define GPAC_SVN_REVISION \"$version\"" > ../../../include/gpac/version.h || exit 1
echo "Building lib gpac ..."
mkdir ../../../bin/android 2>/dev/null
cd ../../../ || exit 1
BASEPATH=$(pwd)

rm -rf $BUILDPATH/../obj/local/armeabi/* || mkdir $BUILDPATH/../obj/local/armeabi
rm -rf $BUILDPATH/../obj/local/armeabi-v7a/* || mkdir $BUILDPATH/../obj/local/armeabi-v7a


cd $BUILDPATH || exit 1
echo -n "Buiding all libs from $BUILDPATH..."
ndk-build $* && echo "[OK] build successful." || echo "Build FAILED" || exit 1

#echo "Copying modules to modules dir..."
cd ../libs/ || exit 1
#for i in $(find . -name 'gm*.so')
#do
#	echo -n "$i..."
#	cp "$i" "$BASEPATH/applications/osmo4_android/res/raw/" || exit 1
#done
#echo
#echo "[OK] success." 

LIBS_DIR="$BASEPATH/applications/osmo4_android/libs/"
echo "Copying libs to libs dir $LIBS_DIR ..."
for i in $(find . -name '*.so')
do
	echo -n "$i..."
	cp "$i" "$LIBS_DIR/$i" || exit 1
done
echo
echo "[OK] success."
cd "$BASEPATH/extra_lib/lib/android" || exit 1
echo "Copying all extra libs to $LIBS_DIR ..."
for i in $(find . -name '*.so')
do
	echo -n "$i..."
	cp "$i" "$LIBS_DIR/$i" || exit 1
done

echo -n "Buiding Osmo4.apk"

cd $BASEPATH/applications/osmo4_android/
ant release || exit 1

zipalign -v 4 bin/Osmo4-unaligned.apk Osmo4.apk || exit 1
rm bin/Osmo4-*

echo "[OK] success."
